--
-- T21_AIUDR_ZAKAZ  (Trigger) 
--
CREATE OR REPLACE TRIGGER MASTER.T21_AIUDR_ZAKAZ
AFTER INSERT OR DELETE OR UPDATE
ON MASTER.ZAKAZ
FOR EACH ROW
DECLARE
  vId NUMBER;
  TABLE_MUTATING    exception;
  NO_STATEMENT_PARSED	exception;
  pragma exception_init( TABLE_MUTATING,-04091 );
  pragma exception_init( NO_STATEMENT_PARSED,-01003 );
  vKOL NUMBER;
  vVES NUMBER;
  vSPEED_VES NUMBER;
  vSPEED_KOL NUMBER;
BEGIN


  /* обработка мутаций при попытке обращени€ к таблице ZAKAZ_HIST */
/*  BEGIN
    -- ѕосле обновлени€
    IF UPDATING() THEN
      -- ≈сли нет первоначальной позиции - добавить ее
      BEGIN
	    SELECT ID,VES,KOL,SPEED_VES,SPEED_KOL INTO vID,vVES,vKOL,vSPEED_VES,vSPEED_KOL
	  	  FROM ZAKAZ_HIST
	    WHERE ZAKAZ_ID=:NEW.ID
	      AND STATUS_ZAKAZ_ID=10;
	  EXCEPTION
	    WHEN OTHERS THEN
	      vID:=0;
		  vVES:=:NEW.VES;
		  vKOL:=:NEW.KOL;
		  vSPEED_VES:=:NEW.SPEED_VES;
		  vSPEED_KOL:=:NEW.SPEED_KOL;
	  END;

      vID:=FOR_ZAKAZ.AddZakazHist(0,vID,1,1,:NEW.ID,10,:NEW.CLIENT_NUMBER,
	      :NEW.CLIENT_DATE, :NEW.INPUT_NUMBER, :NEW.INPUT_DATE, :NEW.PROD_ID_NPR,
		  NULL, :NEW.STAN_ID, :NEW.POLUCH_ID, :NEW.POTREB_ID,:NEW.PRICE, vVES, vKOL,
		  vSPEED_VES, vSPEED_KOL, '',0,0,0,0,NULL,:NEW.BEGIN_DATE,:NEW.LINK_ID,:NEW.LINK_HIST_ID);
    END IF;

    -- ѕосле добавлени€
    IF INSERTING() THEN
	  vID:=FOR_ZAKAZ.AddZakazHist(0,NULL,1,1,:NEW.ID,10,:NEW.CLIENT_NUMBER,
	      :NEW.CLIENT_DATE, :NEW.INPUT_NUMBER, :NEW.INPUT_DATE, :NEW.PROD_ID_NPR,
		  NULL, :NEW.STAN_ID, :NEW.POLUCH_ID, :NEW.POTREB_ID,:NEW.PRICE, :NEW.VES, :NEW.KOL,
		  :NEW.SPEED_VES, :NEW.SPEED_KOL, '',0,0,0,0,NULL,:NEW.BEGIN_DATE,:NEW.LINK_ID,:NEW.LINK_HIST_ID);
    END IF;
--  exception
--    when TABLE_MUTATING or NO_STATEMENT_PARSED then null;
  end;*/
  NULL;

END;
/


