--
-- RENEW_ORG_STRUCTURE  (Procedure) 
--
CREATE OR REPLACE PROCEDURE MASTER.Renew_Org_Structure(DATE_BEG DATE:=TRUNC(SYSDATE,'MONTH') ,DATE_END DATE:=SYSDATE, param1 VARCHAR2:='', param2 VARCHAR2:='', param3 VARCHAR2:='') IS
BEGIN

  -- Обновление объектов
/*  UPDATE ORG_STRUCTURE B SET
    (NAME, ORG_KIND_ID, WORKSHOP)=
	(SELECT A.OBIEKT, DECODE(A.TIP_OB, 1, 1, 5), TO_CHAR(A.CECH)
	   FROM load_buffer.kod_ob A WHERE A.kod_ob=B.ID)
    WHERE IS_AUTO_KONS=1 AND EXISTS 
  	  (SELECT NULL FROM load_buffer.kod_ob A WHERE A.kod_ob=B.ID);*/

  INSERT INTO ORG_STRUCTURE 
    (ID, ADRESS, NAME, FULL_NAME, ORG_KIND_ID, ORG_TYPE_ID, WORKSHOP)
	SELECT A.KOD_OB, '?', A.OBIEKT, A.OBIEKT, DECODE(A.TIP_OB, 1, 1, 5), 1, TO_CHAR(A.CECH)
	   FROM load_buffer.kod_ob A 
	   WHERE NOT EXISTS (SELECT NULL FROM ORG_STRUCTURE B WHERE A.kod_ob=B.ID)
	    AND kod_ob not in (1091,1092,2033,9071,9072,9073,9074,9075,9080,11022,11029,11034,11036,11044,11046,11083,11084,12001,12002,12007,12008,13001,13002);
	  
  COMMIT;

  -- Обновление связей
  UPDATE ORG_RELATIONS B SET
    (ORG_STRU_2_ID, KIND_RELA_ID)=
	(SELECT C.ID, 1
	   FROM load_buffer.kod_ob A, ORG_STRUCTURE C WHERE A.KOD_FIL=C.FILIAL AND A.kod_ob=B.ORG_STRU_1_ID AND C.IS_AUTO_KONS=1)
    WHERE EXISTS 
  	  (SELECT NULL
	   FROM load_buffer.kod_ob A, ORG_STRUCTURE C WHERE A.KOD_FIL=C.FILIAL AND A.kod_ob=B.ORG_STRU_1_ID AND C.IS_AUTO_KONS=1);

  INSERT INTO ORG_RELATIONS
    (ORG_STRU_1_ID, ORG_STRU_2_ID, KIND_RELA_ID) 
	SELECT A.KOD_OB, C.ID, 1
	   FROM load_buffer.kod_ob A, ORG_STRUCTURE C WHERE A.KOD_FIL=C.FILIAL AND 
	   NOT EXISTS 
  	  (SELECT NULL FROM ORG_RELATIONS B WHERE A.kod_ob=B.ORG_STRU_1_ID)   
  	  AND kod_ob not in (1091,1092,2033,9071,9072,9073,9074,9075,9080,11022,11029,11034,11036,11044,11046,11083,11084,12001,12002,12007,12008,13001,13002);
  
  COMMIT;

END Renew_Org_Structure; 
/

