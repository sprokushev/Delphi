--
-- RENEW_KLS_PASP  (Procedure) 
--
CREATE OR REPLACE PROCEDURE MASTER.RENEW_KLS_PASP (DATE_BEG DATE:=TRUNC(SYSDATE,'MONTH') ,DATE_END DATE:=SYSDATE, param1 VARCHAR2:='', param2 VARCHAR2:='', param3 VARCHAR2:='') IS
BEGIN

 UPDATE load_buffer.ZAGPASP set DAT_=DINS WHERE DAT_ IS NULL;

 UPDATE kls_pasp
    set (PASP_NUM,REZ_NUM,PASP_DATE,INSPEKTOR,DATE_OFORML,PROD_ID_NPR,MESTO_ID,DATEUPLOAD,DATE_VIR,PASP_TYP,VZLIV) =
	    (SELECT A.NUM_PASP,A.NUM_REZ,A.DINS,A.NINS,
		    TO_DATE(TO_CHAR(A.dat_,'dd.mm.yyyy ') || SUBSTR(A.tim_,1,5),'dd.mm.yyyy hh24:mi'),
			A.KOD_NPR,A.MESTO,A.DATEUPLOAD,A.DATE_VIR,A.PASP_TYP,A.VZLIV FROM load_buffer.ZAGPASP A
		  WHERE A.KODPASP=kls_pasp.id)
  where exists (SELECT load_buffer.ZAGPASP.KODPASP FROM load_buffer.ZAGPASP
                 where load_buffer.ZAGPASP.KODPASP=kls_pasp.id);

  COMMIT;

  INSERT INTO kls_pasp (ID,PASP_NUM,REZ_NUM,PASP_DATE,INSPEKTOR,DATE_OFORML,PROD_ID_NPR,MESTO_ID,DATEUPLOAD,DATE_VIR,PASP_TYP,VZLIV)
    (SELECT C.KODPASP,C.NUM_PASP,C.NUM_REZ,C.DINS,C.NINS,
		    TO_DATE(TO_CHAR(C.dat_,'dd.mm.yyyy ') || SUBSTR(C.tim_,1,5),'dd.mm.yyyy hh24:mi'),
			C.KOD_NPR,C.MESTO,C.DATEUPLOAD,C.DATE_VIR,C.PASP_TYP,C.VZLIV FROM load_buffer.ZAGPASP C
      WHERE not exists (SELECT kls_pasp.id FROM kls_pasp where kls_pasp.id=C.KODPASP));

  COMMIT;

  DELETE FROM KLS_PASP WHERE MESTO_ID>0 
     AND NOT EXISTS (SELECT E.KODPASP from load_buffer.ZAGPASP E WHERE E.KODPASP = KLS_PASP.ID) 
	 AND KLS_PASP.DATEUPLOAD BETWEEN date_beg AND date_end;

  COMMIT;
END RENEW_KLS_PASP;

/

