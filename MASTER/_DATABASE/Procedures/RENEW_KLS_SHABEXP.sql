--
-- RENEW_KLS_SHABEXP  (Procedure) 
--
CREATE OR REPLACE PROCEDURE MASTER.RENEW_KLS_SHABEXP(DATE_BEG DATE:=TRUNC(SYSDATE,'MONTH') ,DATE_END DATE:=SYSDATE, param1 VARCHAR2:='', param2 VARCHAR2:='', param3 VARCHAR2:='') IS
BEGIN

  UPDATE kls_shabexp
    set (FLG_DOSTUP,DOG_ID,PROD_ID_NPR,STAN_ID,PRIM_DOG,OSOB1,OSOB2,OSOB3,OSOB4,POL1,POL2,POL3,POL4,
         NEOB1,NEOB2,NEOB3,NEOB4,STAN1,STAN2,STAN3,STAN4,DORST1,DORST2,NM_GR1,NM_GR2,NM_GR3,NM_GR4,
         NM_GR5,NM_GR6,NM_GR7,NM_GR8,NM_GR9,PLT_OT1,PLT_OT2,PLT_OT3,PLT_OT4,DOCS1,DOCS2,DOCS3,DOCS4,
         TAM1,TAM2,POS33,POS34,POS35,POS36,SHTAMP1,SHTAMP2,SHTAMP3,SHTAMP4,SHTAMP5,CNT_VED, MESTO_PAY, 
         GR1_TXT_EX, GR2_TXT_EX, INSNUM, INSDAT) =
	(SELECT IIF(DOSTUP,1,0),DOG_ID,KOD_NPR,STAN_ID,PRIM_D,OSOB1,OSOB2,OSOB3,OSOB4,POL1,POL2,POL3,POL4,
         NEOB1,NEOB2,NEOB3,NEOB4,STAN1,STAN2,STAN3,STAN4,DORST1,DORST2,NM_GR1,NM_GR2,NM_GR3,NM_GR4,
         NM_GR5,NM_GR6,NM_GR7,NM_GR8,NM_GR9,PLT_OT1,PLT_OT2,PLT_OT3,PLT_OT4,DOCS1,DOCS2,DOCS3,DOCS4,
         TAM1,TAM2,POS33,POS34,POS35,POS36,SHTAMP1,SHTAMP2,SHTAMP3,SHTAMP4,SHTAMP5,CNT_VED, MESTO_PAY, 
         GR1_TXT_EX, GR2_TXT_EX, INSNUM, INSDAT
		 FROM load_buffer.export_grp WHERE NN=kls_shabexp.id)
    where exists (SELECT * FROM load_buffer.export_grp B WHERE B.nn=kls_shabexp.id);

  INSERT INTO kls_shabexp
     (ID,FLG_DOSTUP,DOG_ID,PROD_ID_NPR,STAN_ID,PRIM_DOG,OSOB1,OSOB2,OSOB3,OSOB4,POL1,POL2,POL3,POL4,
         NEOB1,NEOB2,NEOB3,NEOB4,STAN1,STAN2,STAN3,STAN4,DORST1,DORST2,NM_GR1,NM_GR2,NM_GR3,NM_GR4,
         NM_GR5,NM_GR6,NM_GR7,NM_GR8,NM_GR9,PLT_OT1,PLT_OT2,PLT_OT3,PLT_OT4,DOCS1,DOCS2,DOCS3,DOCS4,
         TAM1,TAM2,POS33,POS34,POS35,POS36,SHTAMP1,SHTAMP2,SHTAMP3,SHTAMP4,SHTAMP5,CNT_VED, MESTO_PAY, 
         GR1_TXT_EX, GR2_TXT_EX, INSNUM, INSDAT)
	(SELECT DISTINCT NN,IIF(DOSTUP,1,0),DOG_ID,KOD_NPR,STAN_ID,PRIM_D,OSOB1,OSOB2,OSOB3,OSOB4,POL1,POL2,POL3,POL4,
         NEOB1,NEOB2,NEOB3,NEOB4,STAN1,STAN2,STAN3,STAN4,DORST1,DORST2,NM_GR1,NM_GR2,NM_GR3,NM_GR4,
         NM_GR5,NM_GR6,NM_GR7,NM_GR8,NM_GR9,PLT_OT1,PLT_OT2,PLT_OT3,PLT_OT4,DOCS1,DOCS2,DOCS3,DOCS4,
         TAM1,TAM2,POS33,POS34,POS35,POS36,SHTAMP1,SHTAMP2,SHTAMP3,SHTAMP4,SHTAMP5,CNT_VED, MESTO_PAY, 
         GR1_TXT_EX, GR2_TXT_EX, INSNUM, INSDAT
 		 FROM load_buffer.export_grp
		 WHERE not exists (SELECT B.ID FROM kls_shabexp B WHERE B.ID=NN));

  INSERT INTO kls_shabexp
        (ID,FLG_DOSTUP,DOG_ID,PROD_ID_NPR,STAN_ID)
		(SELECT DISTINCT 0,0,4,'00000',1 FROM load_buffer.export_grp WHERE
          not exists (SELECT E.ID FROM kls_shabexp E where E.ID=0));

  COMMIT;

END RENEW_KLS_SHABEXP; 
/

