--
-- V_KVIT_DATE_VIR_ALL  (View) 
--
CREATE OR REPLACE FORCE VIEW MASTER.V_KVIT_DATE_VIR_ALL
(ID, FLG_OPERDATA, MESTO_ID, NOM_ZD, PROD_ID_NPR, 
 TEX_PD_ID, NUM_CIST, DATE_OTGR, VES, VES_BRUTTO, 
 VES_ED, KOL_ED, TARIF, TARIF19, TARIF_ORIG, 
 NUM_KVIT, DATE_KVIT, NUM_MILITARY, FLG_DOP_CIST, FLG_VAG_KLIENT, 
 VAGOWNER_ID, VAGONTYPE_ID, KALIBR_ID, VES_CIST, DATE_VOZ, 
 KVIT_VOZ, SUM_VOZ, DATE_OTV, PLOMBA1, PLOMBA2, 
 ROSINSPL1, ROSINSPL2, VZLIV, TEMPER, FAKT_PL, 
 FORMNAKL_ID, SHABEXP_ID, GTD, EXPED_ID, VETKA_OTP_ID, 
 NUM_EXP_MAR, BILL_ID, SVED_ID, DATE_OFORML, SVED_NUM, 
 PASP_ID, NUM_NAR, NUM_DOVER, PERER_ID, DATE_EDIT, 
 JKCOMMIT, GROTP_ID, PERECH_TEXPD_DATE, PERECH_TEXPD_NUM, SUM_PROD, 
 SUM_AKCIZ, SUM_PROD_NDS, TARIF_NDS, SUM_VOZN11, SUM_VOZN11_NDS, 
 SUM_VOZN12, SUM_VOZN12_NDS, NACENKA, SUM_STRAH, CENA_VOZN, 
 TARIF_GUARD, TARIF_GUARD_NDS, TARIF_ALT, CENA, CENA_OTP, 
 NUM_AKT, BILL_POS_ID, PROTO_NUM, PROTO_DATE, NO_AKCIZ, 
 PERECH_GUARD_DATE, PERECH_GUARD_NUM, OWNERSHIP_ID, DATE_VIR)
AS 
SELECT /*+ ORDERED USE_NL(a,b) INDEX(b KVIT_DATE_VIR_BILL_I) */
a.ID,
a.FLG_OPERDATA,
a.MESTO_ID,
a.NOM_ZD,
a.PROD_ID_NPR,
a.TEX_PD_ID,
a.NUM_CIST,
a.DATE_OTGR,
NVL(b.VES,a.VES) as VES,
NVL(b.VES,a.VES_BRUTTO) as VES_BRUTTO,
a.VES_ED,
a.KOL_ED,
NVL(b.TARIF,a.TARIF) as TARIF,
NVL(b.TARIF19,a.TARIF19) as TARIF19,
NVL(b.TARIF_ORIG,a.TARIF_ORIG) as TARIF_ORIG,
a.NUM_KVIT,
a.DATE_KVIT,
a.NUM_MILITARY,
a.FLG_DOP_CIST,
a.FLG_VAG_KLIENT,
a.VAGOWNER_ID,
a.VAGONTYPE_ID,
a.KALIBR_ID,
NVL(b.VES_CIST,a.VES_CIST) as VES_CIST,
a.DATE_VOZ,
a.KVIT_VOZ,
a.SUM_VOZ,
a.DATE_OTV,
a.PLOMBA1,
a.PLOMBA2,
a.ROSINSPL1,
a.ROSINSPL2,
NVL(b.VZLIV,a.VZLIV) as VZLIV,
a.TEMPER,
a.FAKT_PL,
a.FORMNAKL_ID,
a.SHABEXP_ID,
a.GTD,
a.EXPED_ID,
a.VETKA_OTP_ID,
a.NUM_EXP_MAR,
a.BILL_ID,
a.SVED_ID,
a.DATE_OFORML,
a.SVED_NUM,
a.PASP_ID,
a.NUM_NAR,
a.NUM_DOVER,
a.PERER_ID,
a.DATE_EDIT,
a.JKCOMMIT,
a.GROTP_ID,
a.PERECH_TEXPD_DATE,
a.PERECH_TEXPD_NUM,
NVL(b.SUM_PROD,a.SUM_PROD) as SUM_PROD,
NVL(b.SUM_AKCIZ,a.SUM_AKCIZ) as SUM_AKCIZ,
NVL(b.SUM_PROD_NDS,a.SUM_PROD_NDS) as SUM_PROD_NDS,
NVL(b.TARIF_NDS,a.TARIF_NDS) as TARIF_NDS,
NVL(b.SUM_VOZN11,a.SUM_VOZN11) as SUM_VOZN11,
NVL(b.SUM_VOZN11_NDS,a.SUM_VOZN11_NDS) as SUM_VOZN11_NDS,
NVL(b.SUM_VOZN12,a.SUM_VOZN12) as SUM_VOZN12,
NVL(b.SUM_VOZN12_NDS,a.SUM_VOZN12_NDS) as SUM_VOZN12_NDS,
a.NACENKA,
NVL(b.SUM_STRAH,a.SUM_STRAH) as SUM_STRAH,
a.CENA_VOZN,
NVL(b.TARIF_GUARD,a.TARIF_GUARD) as TARIF_GUARD,
NVL(b.TARIF_GUARD_NDS,a.TARIF_GUARD_NDS) as TARIF_GUARD_NDS,
NVL(b.TARIF_ALT,a.TARIF_ALT) as TARIF_ALT,
a.CENA,
a.CENA_OTP,
a.NUM_AKT,
NVL(b.BILL_POS_ID,a.BILL_POS_ID) as BILL_POS_ID,
a.PROTO_NUM,
a.PROTO_DATE,
a.NO_AKCIZ,
a.PERECH_GUARD_DATE,
a.PERECH_GUARD_NUM,
NVL(b.OWNERSHIP_ID,1) as OWNERSHIP_ID,
NVL(b.DATE_VIR,TRUNC(a.DATE_KVIT,'MONTH')) as DATE_VIR
FROM (SELECT /*+ INDEX(kvit) */ * FROM kvit union all select /*+ INDEX(dop_kvit) */ * from dop_kvit) a,KVIT_DATE_VIR b
WHERE a.BILL_ID=b.BILL_ID(+)
AND a.ID=b.KVIT_ID(+)
--AND a.DATE_KVIT>=TO_DATE('01.01.2005','dd.mm.yyyy')
;


