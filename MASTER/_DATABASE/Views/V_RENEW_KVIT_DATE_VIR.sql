--
-- V_RENEW_KVIT_DATE_VIR  (View) 
--
CREATE OR REPLACE FORCE VIEW MASTER.V_RENEW_KVIT_DATE_VIR
(DATE_PLAN, BILL_ID, KVIT_ID, DATE_VIR, NOM_SF_POKUP, 
 NOM_DOK_POKUP, BILL_POS_ID, VES_BRUTTO, VES, VES_CIST, 
 VZLIV, KOL_NET, SUM_PROD, SUM_PROD_NDS, SUM_AKCIZ, 
 TARIF_ORIG, TARIF_ALT, TARIF, TARIF19, TARIF_NDS, 
 TARIF_GUARD, TARIF_GUARD_NDS, SUM_VOZN11, SUM_VOZN11_NDS, SUM_VOZN12, 
 SUM_VOZN12_NDS, SUM_STRAH, VES_BRUTTO_ALL, VES_ALL, VES_CIST_ALL, 
 VZLIV_ALL, KOL_NET_ALL, SUM_PROD_ALL, SUM_PROD_NDS_ALL, SUM_AKCIZ_ALL, 
 TARIF_ORIG_ALL, TARIF_ALT_ALL, TARIF_ALL, TARIF19_ALL, TARIF_NDS_ALL, 
 TARIF_GUARD_ALL, TARIF_GUARD_NDS_ALL, SUM_VOZN11_ALL, SUM_VOZN11_NDS_ALL, SUM_VOZN12_ALL, 
 SUM_VOZN12_NDS_ALL, SUM_STRAH_ALL)
AS 
SELECT /*+ ORDERED INDEX(a) USE_NL(a,b) */
  a.month as DATE_PLAN,
  a.IDINVOICE as BILL_ID,
  a.ID as KVIT_ID,
  a.PERIOD as DATE_VIR,
  a.BUYINVC as NOM_SF_POKUP,
  NULL as NOM_DOK_POKUP,
  NVL(b.BILL_POS_ID,1) as BILL_POS_ID,
  a.QUAN as VES_BRUTTO,
  ROUND(b.VES/b.VES_BRUTTO*a.QUAN,3) as VES,
  ROUND(b.VES_CIST/b.VES_BRUTTO*a.QUAN,3) as VES_CIST,
  ROUND(b.VZLIV/b.VES_BRUTTO*a.QUAN,0) as VZLIV,
  ROUND(NVL(b.KOL_NET,0)/b.VES_BRUTTO*a.QUAN,6) as KOL_NET,
  ROUND(b.SUM_PROD/b.VES_BRUTTO*a.QUAN,2) as SUM_PROD,
  ROUND(b.SUM_PROD_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_PROD_NDS,
  ROUND(b.SUM_AKCIZ/b.VES_BRUTTO*a.QUAN,2) as SUM_AKCIZ,
  ROUND(b.TARIF_ORIG/b.VES_BRUTTO*a.QUAN,2) as TARIF_ORIG,
  ROUND(b.TARIF_ALT/b.VES_BRUTTO*a.QUAN,2) as TARIF_ALT,
  ROUND(b.TARIF/b.VES_BRUTTO*a.QUAN,2) as TARIF,
  ROUND(b.TARIF19/b.VES_BRUTTO*a.QUAN,2) as TARIF19,
  ROUND(b.TARIF_NDS/b.VES_BRUTTO*a.QUAN,2) as TARIF_NDS,
  ROUND(b.TARIF_GUARD/b.VES_BRUTTO*a.QUAN,2) as TARIF_GUARD,
  ROUND(b.TARIF_GUARD_NDS/b.VES_BRUTTO*a.QUAN,2) as TARIF_GUARD_NDS,
  ROUND(b.SUM_VOZN11/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN11,
  ROUND(b.SUM_VOZN11_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN11_NDS,
  ROUND(b.SUM_VOZN12/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN12,
  ROUND(b.SUM_VOZN12_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN12_NDS,
  ROUND(b.SUM_STRAH/b.VES_BRUTTO*a.QUAN,2) as SUM_STRAH,
  b.VES_BRUTTO as VES_BRUTTO_ALL,
  b.VES as VES_ALL,
  b.VES_CIST as VES_CIST_ALL,
  b.VZLIV as VZLIV_ALL,
  NVL(b.KOL_NET,0) as KOL_NET_ALL,
  b.SUM_PROD as SUM_PROD_ALL,
  b.SUM_PROD_NDS as SUM_PROD_NDS_ALL,
  b.SUM_AKCIZ as SUM_AKCIZ_ALL,
  b.TARIF_ORIG as TARIF_ORIG_ALL,
  b.TARIF_ALT as TARIF_ALT_ALL,
  b.TARIF as TARIF_ALL,
  b.TARIF19 as TARIF19_ALL,
  b.TARIF_NDS as TARIF_NDS_ALL,
  b.TARIF_GUARD as TARIF_GUARD_ALL,
  b.TARIF_GUARD_NDS as TARIF_GUARD_NDS_ALL,
  b.SUM_VOZN11 as SUM_VOZN11_ALL,
  b.SUM_VOZN11_NDS as SUM_VOZN11_NDS_ALL,
  b.SUM_VOZN12 as SUM_VOZN12_ALL,
  b.SUM_VOZN12_NDS as SUM_VOZN12_NDS_ALL,
  b.SUM_STRAH as SUM_STRAH_ALL
 FROM moveprod a, kvit b
WHERE a.IDINVOICE=b.BILL_ID
  AND a.ID=b.ID
  AND a.month>=TO_DATE('01.01.2005','dd.mm.yyyy')
  AND a.oper<>1
UNION
SELECT /*+ ORDERED INDEX(a) USE_NL(a,b) */
  a.month as DATE_PLAN,
  a.IDINVOICE as BILL_ID,
  a.ID as KVIT_ID,
  a.PERIOD as DATE_VIR,
  a.BUYINVC as NOM_SF_POKUP,
  NULL as NOM_DOK_POKUP,
  NVL(b.BILL_POS_ID,1) as BILL_POS_ID,
  a.QUAN as VES_BRUTTO,
  ROUND(b.VES/b.VES_BRUTTO*a.QUAN,3) as VES,
  ROUND(b.VES_CIST/b.VES_BRUTTO*a.QUAN,3) as VES_CIST,
  ROUND(b.VZLIV/b.VES_BRUTTO*a.QUAN,0) as VZLIV,
  ROUND(NVL(b.KOL_NET,0)/b.VES_BRUTTO*a.QUAN,6) as KOL_NET,
  ROUND(b.SUM_PROD/b.VES_BRUTTO*a.QUAN,2) as SUM_PROD,
  ROUND(b.SUM_PROD_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_PROD_NDS,
  ROUND(b.SUM_AKCIZ/b.VES_BRUTTO*a.QUAN,2) as SUM_AKCIZ,
  ROUND(b.TARIF_ORIG/b.VES_BRUTTO*a.QUAN,2) as TARIF_ORIG,
  ROUND(b.TARIF_ALT/b.VES_BRUTTO*a.QUAN,2) as TARIF_ALT,
  ROUND(b.TARIF/b.VES_BRUTTO*a.QUAN,2) as TARIF,
  ROUND(b.TARIF19/b.VES_BRUTTO*a.QUAN,2) as TARIF19,
  ROUND(b.TARIF_NDS/b.VES_BRUTTO*a.QUAN,2) as TARIF_NDS,
  ROUND(b.TARIF_GUARD/b.VES_BRUTTO*a.QUAN,2) as TARIF_GUARD,
  ROUND(b.TARIF_GUARD_NDS/b.VES_BRUTTO*a.QUAN,2) as TARIF_GUARD_NDS,
  ROUND(b.SUM_VOZN11/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN11,
  ROUND(b.SUM_VOZN11_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN11_NDS,
  ROUND(b.SUM_VOZN12/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN12,
  ROUND(b.SUM_VOZN12_NDS/b.VES_BRUTTO*a.QUAN,2) as SUM_VOZN12_NDS,
  ROUND(b.SUM_STRAH/b.VES_BRUTTO*a.QUAN,2) as SUM_STRAH,
  b.VES_BRUTTO as VES_BRUTTO_ALL,
  b.VES as VES_ALL,
  b.VES_CIST as VES_CIST_ALL,
  b.VZLIV as VZLIV_ALL,
  NVL(b.KOL_NET,0) as KOL_NET_ALL,
  b.SUM_PROD as SUM_PROD_ALL,
  b.SUM_PROD_NDS as SUM_PROD_NDS_ALL,
  b.SUM_AKCIZ as SUM_AKCIZ_ALL,
  b.TARIF_ORIG as TARIF_ORIG_ALL,
  b.TARIF_ALT as TARIF_ALT_ALL,
  b.TARIF as TARIF_ALL,
  b.TARIF19 as TARIF19_ALL,
  b.TARIF_NDS as TARIF_NDS_ALL,
  b.TARIF_GUARD as TARIF_GUARD_ALL,
  b.TARIF_GUARD_NDS as TARIF_GUARD_NDS_ALL,
  b.SUM_VOZN11 as SUM_VOZN11_ALL,
  b.SUM_VOZN11_NDS as SUM_VOZN11_NDS_ALL,
  b.SUM_VOZN12 as SUM_VOZN12_ALL,
  b.SUM_VOZN12_NDS as SUM_VOZN12_NDS_ALL,
  b.SUM_STRAH as SUM_STRAH_ALL
 FROM moveprod a, dop_kvit b
WHERE a.IDINVOICE=b.BILL_ID
  AND a.ID=b.ID
  AND a.month>=TO_DATE('01.01.2005','dd.mm.yyyy')
  AND a.oper<>1;


