--
-- V_LUKREP_SF_MON  (View) 
--
CREATE OR REPLACE FORCE VIEW MASTER.V_LUKREP_SF_MON
(NEW_NOM_DOK, NUM_5_DAY, IS_KORR, IS_AGENT, IS_SILOV, 
 SOBSTV, PLAT_ID, PLAT_INN, PLAT_NAME, PLAT_ADDR, 
 DOG_ID, DOG_NUMBER, DOG_DATE, DATE_KVIT, DATE_MOS, 
 DATE_CHN_SOB, NOM_DOK, NOM_SF, ORIG_NOM_SF, OLD_NOM_DOK, 
 OLD_NOM_SF, NPO_SF, DATE_VYP_SF, GR_NPR_ID, GR_NPR_NAME, 
 PROD_ID_NPR, PROD_NAME, PROD_EDIZ, KVIT_ID, VES, 
 VES_KVIT, CNT_KVIT, SVED_NUM, NUM_KVIT, NOM_AKT, 
 NUM_CIST, STANOTP_ID, STAN_NAME, HRAN_ID, HRAN_NAME, 
 POLUCH_ID, POLUCH_NAME, POLUCH_ADDR, IS_SF, CENA_BN, 
 CENA, SUMMA_PROD_BN, SUMMA_PROD_NDS, SUMMA_PROD, SUMMA_AGEN, 
 SUMMA_AGEN_NDS, SUMMA_VOZN_BN, SUMMA_TARIF, SUMMA_TARIF_NDS, SUMMA_OHRANA, 
 SUMMA_OHRANA_NDS, TARIF_MPS, TARIF_KVIT, SUMMA_RAZN_BN, NACENKA, 
 SUMMA_STRAH, SUMMA_STRAH_NEW, SUMMA_DOK, SUMMA_DOK_NDS, PRICE_PROTOKOL, 
 KOL_DN, NAZN_OTG_ID, SNP_PLAT_ID, SNP_PLAT_NAME, RAST, 
 NUM_STRAH, USL_SUM, VAGOWN_TYP_ID, DATE_VYR, KORR_PROD, 
 STRAH_NOM_SF, STRAH_SUMMA_DOK, VID_USL_ID)
AS 
SELECT /*+ ALL_ROWS */ 
 TO_CHAR(NOM_DOK) || TO_CHAR(B.DATEVYR,'YYYYMMDD') as NEW_NOM_DOK, 
 NUM_5_DAY, 
 IS_KORR, 
 IS_AGENT, 
 IS_SILOV, 
 SOBSTV, 
 PLAT_ID, 
 PLAT_INN, 
 PLAT_NAME, 
 PLAT_ADDR, 
 DOG_ID, 
 DOG_NUMBER, 
 DOG_DATE, 
 DATE_KVIT, 
 DATE_MOS, 
 DATE_CHN_SOB, 
 NOM_DOK, 
 NOM_SF, 
 ORIG_NOM_SF, 
 OLD_NOM_DOK, 
 OLD_NOM_SF, 
 NPO_SF, 
 DATE_VYP_SF, 
 GR_NPR_ID, 
 GR_NPR_NAME, 
 PROD_ID_NPR, 
 PROD_NAME, 
 PROD_EDIZ, 
 KVIT_ID, 
 DECODE(A.VES,0,0,NVL(B.KOL,A.VES)) as VES, 
 VES_KVIT, 
 CNT_KVIT, 
 SVED_NUM, 
 NUM_KVIT, 
 NOM_AKT, 
 NUM_CIST, 
 STANOTP_ID, 
 STAN_NAME, 
 HRAN_ID, 
 HRAN_NAME, 
 POLUCH_ID, 
 POLUCH_NAME, 
 POLUCH_ADDR, 
 IS_SF, 
 A.CENA_BN, 
 A.CENA, 
 DECODE(A.VES,0,0,NVL(B.SUMMA,A.SUMMA_PROD_BN)) as SUMMA_PROD_BN, 
 DECODE(A.VES,0,0,NVL(B.SUMNDS,A.SUMMA_PROD_NDS)) as SUMMA_PROD_NDS, 
 DECODE(A.VES,0,0,NVL(B.ALLNDS,A.SUMMA_PROD)) as SUMMA_PROD, 
 SUMMA_AGEN, 
 SUMMA_AGEN_NDS, 
 SUMMA_VOZN_BN, 
 SUMMA_TARIF, 
 SUMMA_TARIF_NDS, 
 SUMMA_OHRANA, 
 SUMMA_OHRANA_NDS, 
 TARIF_MPS, 
 TARIF_KVIT, 
 SUMMA_RAZN_BN, 
 NACENKA, 
 SUMMA_STRAH, 
 ROUND(SUMMA_STRAH*DECODE(B.KOL,NULL,1,DECODE(A.VES,0,1,B.KOL/A.VES)),2) as SUMMA_STRAH_NEW, 
 SUMMA_DOK, 
 SUMMA_DOK_NDS, 
 PRICE_PROTOKOL, 
 KOL_DN, 
 NAZN_OTG_ID, 
 SNP_PLAT_ID, 
 SNP_PLAT_NAME, 
 RAST, 
 NUM_STRAH, 
 DECODE(SUMMA_VOZN_11_BN,0,DECODE(SUMMA_VOZN_12_BN,0,0,DECODE(NVL(VES_KVIT,0),0,0,ROUND(SUMMA_VOZN_BN/VES_KVIT,0))),USL_SUM) as USL_SUM, 
 VAGOWN_TYP_ID, 
 B.DATEVYR, KORR_PROD, STRAH_NOM_SF, STRAH_SUMMA_DOK,VID_USL_ID 
FROM MASTER.V_LUKREP_SF_NEW_BEFORE A, 
( 
SELECT 
   KOD_PROD, 
   DATEVYR, 
   SUM(KOL) as KOL, 
   SUM(SUMMA) as SUMMA, 
   SUM(SUMNDS) as SUMNDS, 
   SUM(ALLNDS) as ALLNDS 
  FROM SVETA.SF_POZ_VYR 
  GROUP BY 
   KOD_PROD, 
   DATEVYR 
) B 
WHERE A.NOM_DOK=B.KOD_PROD(+);


