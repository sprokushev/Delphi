--
-- V_USER_MONTH_SNP  (View) 
--
CREATE OR REPLACE FORCE VIEW MASTER.V_USER_MONTH_SNP
(NOM_ZD, STANOTP_ID, NPR_SOBSTV_ID, STAN_ID, VETKA_ID, 
 POLUCH_ID, TEX_PD_ID, NAZN_OTG_ID, LOAD_ABBR, DOG_ID, 
 USL_NUMBER, GOSPROG_ID, PROD_ID_NPR, TONN_DECLARED, TONN_LOADED, 
 CIST_DECLARED, CIST_LOADED, FLG_ALLOW_8_AXES, FLG_UPPER_SLIV, FLG_DOP_CIST, 
 FLG_FORMA_2, FLG_OBOGR, DATE_PLAN, PRIM, CENA, 
 CENA_OTP, SUM_ZD, GR4, K_TAR, INPUT_DATE, 
 UPDATE_DATE, TARIF1TONN, POTREB_ID, PLANSTRU_ID, NPODOG_ID, 
 GROTP_ID, DATE_CEN, GP_NAPR_ID, TONN_R, CIST_R, 
 TRANSPORT, IS_EXP, SUPPLIER_ID, APPL_TAG, CENA_NPO, 
 CENA_OTP_NPO, KOL_DN_NPO, TONN_RAZNAR, CIST_RAZNAR, ZAKAZ_ID, 
 EXPED_ID, GU12_A_ID, ZAKAZ_HIST_ID, POKUP_DOG_ID, POKUP_USL_NUMBER, 
 AFTER_2005, IS_AGENT, ZAKAZ_VES)
AS 
SELECT /*+ ordered use_nl(mon,unp,snp,KLS_USL_OPL) */
  MON.NOM_ZD,
  MON.STANOTP_ID,
  MON.NPR_SOBSTV_ID,
  mon.STAN_ID,
  mon.VETKA_ID,
  mon.POLUCH_ID,
  MON.TEX_PD_ID,
  MON.NAZN_OTG_ID,
  MON.LOAD_ABBR,
  MON.DOG_ID,
  MON.USL_NUMBER,
  DECODE(AFTER_2005,1,snp.GOSPROG_ID,mon.GOSPROG_ID) as GOSPROG_ID,
  mon.PROD_ID_NPR,
  MON.TONN_DECLARED,
  MON.TONN_LOADED,
  MON.CIST_DECLARED,
  MON.CIST_LOADED,
  MON.FLG_ALLOW_8_AXES,
  MON.FLG_UPPER_SLIV,
  MON.FLG_DOP_CIST,
  MON.FLG_FORMA_2,
  MON.FLG_OBOGR,
  MON.DATE_PLAN,
  MON.PRIM,
  MON.CENA,
  MON.CENA_OTP,
  MON.SUM_ZD,
  MON.GR4,
  MON.K_TAR,
  MON.INPUT_DATE,
  MON.UPDATE_DATE,
  MON.TARIF1TONN,
  mon.POTREB_ID,
  DECODE(AFTER_2005,1,snp.PLANSTRU_ID,mon.PLANSTRU_ID) as PLANSTRU_ID,
  DECODE(AFTER_2005,1,NVL(snp.DOG_ID,0),NVL(mon.NPODOG_ID,0)) as NPODOG_ID,
  MON.GROTP_ID,
  MON.DATE_CEN,
  DECODE(AFTER_2005,1,snp.GP_NAPR_ID,mon.GP_NAPR_ID) as GP_NAPR_ID,
  MON.TONN_R,
  MON.CIST_R,
  MON.TRANSPORT,
  MON.IS_EXP,
  MON.SUPPLIER_ID,
  MON.APPL_TAG,
  DECODE(AFTER_2005,1,snp.PRICE,mon.CENA_NPO) as CENA_NPO,
  DECODE(AFTER_2005,1,ROUND(snp.PRICE*FOR_BILLS.GetNDSValue(mon.DATE_PLAN),2),mon.CENA_OTP_NPO) as CENA_OTP_NPO,
  DECODE(AFTER_2005,1,NVL(KLS_USL_OPL.KOL_DN,0),mon.KOL_DN_NPO) as KOL_DN_NPO,
  MON.TONN_RAZNAR,
  MON.CIST_RAZNAR,
  DECODE(AFTER_2005,1,SNP.ID,UNP.ID) as ZAKAZ_ID,
  MON.EXPED_ID,
  MON.GU12_A_ID,
  DECODE(AFTER_2005,1,TO_NUMBER(NULL),MON.ZAKAZ_HIST_ID) as ZAKAZ_HIST_ID,
  MON.POKUP_DOG_ID,
  MON.POKUP_USL_NUMBER,
  mon.AFTER_2005,
  mon.IS_AGENT,
  DECODE(AFTER_2005,1,snp.VES,unp.VES) as ZAKAZ_VES
FROM V_USER_MONTH mon,ZAKAZ unp,ZAKAZ snp,KLS_USL_OPL
WHERE mon.ZAKAZ_ID=unp.ID(+) AND unp.LINK_ID=snp.ID(+) AND snp.USL_OPL_ID=KLS_USL_OPL.ID(+);


