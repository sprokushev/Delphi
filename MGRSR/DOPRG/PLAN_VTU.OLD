*************************Программа обновления ЖД планов из ВТУ*********

PUSH KEY CLEAR
PRIVATE s_excl,s_exac,s_safe,s_talk,s_dele,s_sysm,s_esca,;
        _mes,_god,dir_plan,naim_plan, str_rez, x,y,d_b,t_b
dir_plan='F:\SVODKA\DISPNB\'
*dir_plan='D:\MYRAB\PLAN_GD\'
IF !FILE(dir_plan+'plan_gd\plan_gd.dbf')
   RETURN
ENDIF
IF USED('plan_gd')
   USE IN plan_gd
ENDIF
USE (dir_plan+'plan_gd\plan_gd') IN 0
s_excl=SET('EXCLU')
Set EXCLU Off
s_exac=SET('EXACT')
SET EXACT OFF
s_safe=SET('SAFE')
SET SAFETY OFF
s_talk=SET('TALK')
SET TALK OFF
s_dele=SET('DELE')
SET DELE ON
s_sysm=SET('SYSMENU')
SET SYSMENU OFF
s_esca=SET('ESCAPE')
SET ESCAPE OFF
str_rez=''
x=0
y=0
d_b=DATE()
t_b=TIME()

IF .F.
   USE f:\tov_pr\dbf\prod order tag kod IN 0 ALIAS prodgd AGAIN
   USE f:\tov_pr\dbf\produkt order tag kod IN 0 ALIAS produgd AGAIN
ENDIF

IF USED('evegd')
   USE IN evegd
ENDIF
IF FILE('F:\DBA\DBF\EVENTS.DBF')
   SELE 0
   USE f:\dba\dbf\events ALIAS evegd AGAIN
   APPE BLANK
   REPL kod WITH SUBSTR(SYS(2015),2), date_b WITH d_b, time_b WITH t_b,;
      kod_proc WITH 12, rezult WITH 'Прием плана не завершен'
ENDIF

SELE plan_gd
LOCA FOR mes>0 AND god>0
IF FOUND()
   _mes=ALLTRIM(STR(mes)) &&Новая версия хранения плана Захаровой
   IF LEN(_mes)<2
      _mes=REPLICATE('0',2-LEN(_mes))+_mes
   ENDIF
   _god=ALLTRIM(STR(god))
   IF LEN(_god)<4
      _god=REPLICATE('0',4-LEN(_god))+_god
   ENDIF
   naim_plan='PE'+_god+_mes
   SELECT * FROM plan_gd INTO TABLE (dir_plan+naim_plan)
   SUM kol_vag TO x
   SUM tonn    TO y
   USE
   str_rez='План на '+mnth(_mes,_god)+' : '+ALLTRIM(STR(x))+' вагонов, '+ALLTRIM(STR(y))+' тонн.'

   IF .F.
   SELE plan_gd
   _mes=INT(mes_god/100)
   _god=mes_god-_mes*100
   naim_plan='PER_'+IIF(_god<10,'0','')+ALLTRIM(STR(_god))+IIF(_mes<10,'0','')+ALLTRIM(STR(_mes))
   IF !FILE(dir_plan+naim_plan+'.DBF')
      COPY FILE (dir_plan+'STRU.DBF') TO (dir_plan+naim_plan+'.DBF')
   ENDIF
   USE (dir_plan+naim_plan+'.DBF') IN 0 ALIAS svnplan
   SELECT kod_npr,IIF(gr=500,3,IIF(export_sng='СНГ',2,1)) as prizn_mps,;
          3 as tipv,tonn-tonn_sob AS tonn,;
          kol_vag-kol_vags AS kol,naim_pr AS naim_vtu;
       FROM plan_gd INTO TABLE c:\tmp\mps;
       WHERE tonn<>0
   SELECT kod_npr,IIF(gr=500,3,IIF(export_sng='СНГ',2,1)) as prizn_mps,;
          8 as tipv,tonn_sob AS tonn,kol_vags AS kol,SPACE(20) AS naim_pr,;
          '      ' AS kod_pr,0 AS typnp,000 AS npp;
       FROM plan_gd INTO TABLE c:\tmp\proch;
       WHERE tonn<>0

   APPE FROM c:\tmp\mps.dbf
   USE IN mps
   DELE ALL FOR tonn=0
   SET RELA TO kod_npr INTO prodgd
   REPL ALL kod_pr WITH prodgd.psevdo,naim_pr WITH prodgd.naim_pr,;
            typnp WITH prodgd.typnp,npp with prodgd.npp

   USE (dir_plan+'per_exp') IN 0 ORDER TAG kod_npr   &&Выделяю экспортные продукты
   SET RELA TO kod_npr INTO per_exp
   REPL ALL FOR prizn_mps=3 AND !EMPTY(per_exp.kod_pr) kod_pr WITH per_exp.kod_pr
   USE IN per_exp

   SET RELA TO kod_pr INTO produgd
   REPL ALL FOR !EMPTY(produgd.naim_pr) naim_pr WITH produgd.naim_pr,;
            typnp WITH produgd.typnp,;
            npp WITH produgd.npp
   SET RELA TO
   SELECT kod_pr,naim_pr,typnp,npp,SUM(kol) AS mes_plan,SUM(tonn) AS plan_t,;
          tipv,prizn_mps,1 AS tip_otgr,kod_npr;
      FROM proch INTO TABLE c:\tmp\mps;
      GROUP BY kod_pr,tipv,prizn_mps ORDER BY typnp,npp,kod_pr,tipv,prizn_mps
   USE IN proch
   DELE FILE c:\tmp\proch.dbf
   SET DELE OFF
   SELE svnplan
   SCAN FOR tip_otgr=1 OR DELETED()
        SELE mps
        LOCA FOR !DELETED()
        IF FOUND()
           SCATT MEMVAR
           DELE
           SELE svnplan
           GATH MEMVAR
           RECALL
        ELSE
           SELE svnplan
           DELE
        ENDIF
        SELE svnplan
   ENDSCAN
   SET DELE ON
   SELE mps
   PACK
   SELE svnplan
   APPE FROM c:\tmp\mps
   USE IN mps
   DELE FILE c:\tmp\mps.dbf
   USE IN svnplan
   ENDIF
ELSE
   str_rez='!!!!Не указан месяц и год плана!!!!'
ENDIF

IF USED('evegd')
   IF !EMPTY(str_rez)
      SELE evegd
      REPL date_e WITH DATE(), time_e WITH TIME(), rezult WITH str_rez
   ENDIF
   USE IN evegd
ENDIF
IF EMPTY(str_rez)
   str_rez='Прием плана не завершен'
ENDIF
SET PRINT TO c:\tmp\1.txt
SET PRINT ON
?d_b,'в',SUBSTR(t_b,1,5),str_rez
SET PRINT OFF
SET PRINT TO
x='! COPY '+dir_plan+'PLAN_GD.LOG C:\TMP\2.TXT'
&x
x='! COPY C:\TMP\2.TXT+C:\TMP\1.TXT '+dir_plan+'PLAN_GD.LOG'
&x
DELE FILE c:\tmp\1.txt
DELE FILE c:\tmp\2.txt

USE IN plan_gd
DELE FILE (dir_plan+'plan_gd\plan_gd.dbf')
DELE FILE (dir_plan+'plan_gd\plan_gd.cdx')
POP KEY
Set EXCLU &s_excl
SET EXACT &s_exac
SET SAFETY &s_safe
SET TALK &s_talk
SET DELE &s_dele
SET SYSMENU &s_sysm
SET ESCAPE &s_esca
IF .F.
   USE IN prodgd
   USE IN produgd
ENDIF.
RETURN

PROC mnth
PARA m,g
PRIVATE s,m1
m1=VAL(m)
DO CASE
   CASE m1=1
        s='Январь '
   CASE m1=2
        s='Февраль '
   CASE m1=3
        s='Март '
   CASE m1=4
        s='Апрель '
   CASE m1=5
        s='Май '
   CASE m1=6
        s='Июнь '
   CASE m1=7
        s='Июль '
   CASE m1=8
        s='Август '
   CASE m1=9
        s='Сентябрь '
   CASE m1=10
        s='Октябрь '
   CASE m1=11
        s='Ноябрь '
   CASE m1=12
        s='Декабрь '
   OTHER
        s='* '
ENDCASE
RETURN s+g+' г.'
